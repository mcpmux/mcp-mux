# Reusable workflow: Desktop E2E tests (Linux + Windows)
# Call with workflow_call from ci.yml or e2e-desktop-comment.yml
name: E2E Desktop

on:
  workflow_call:
    inputs:
      ref:
        description: Git ref to checkout (e.g. PR head SHA or github.sha)
        required: true
        type: string
    secrets:
      TAURI_SIGNING_PRIVATE_KEY:
        required: false

env:
  PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig

jobs:
  e2e-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: windows-latest

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Install Linux deps
        if: matrix.os == 'ubuntu-latest'
        uses: ./.github/actions/install-linux-deps
        with:
          e2e: 'true'

      - uses: dtolnay/rust-toolchain@stable
        env:
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-e2e-desktop
        env:
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Cache tauri-driver
        uses: actions/cache@v4
        id: tauri-driver-cache
        with:
          path: ~/.cargo/bin/tauri-driver*
          key: tauri-driver-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install tauri-driver
        if: steps.tauri-driver-cache.outputs.cache-hit != 'true'
        run: cargo install tauri-driver --locked
        env:
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig

      - run: pnpm install --frozen-lockfile

      - name: Build app
        run: pnpm build
        env:
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Run desktop E2E tests (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Start dbus session and unlock gnome-keyring with a dummy password for CI
          dbus-run-session -- bash -c '
            echo "test" | gnome-keyring-daemon --unlock --components=secrets
            export $(gnome-keyring-daemon --start --components=secrets)
            sleep 1
            xvfb-run --auto-servernum pnpm test:e2e
          '

      - name: Run desktop E2E tests (Windows)
        if: matrix.os == 'windows-latest'
        run: pnpm test:e2e

      # Upload test results and artifacts
      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-desktop-results-${{ matrix.os }}
          path: |
            tests/e2e/reports/
            tests/e2e/screenshots/
            tests/e2e/videos/
          retention-days: 7

  # Publish aggregated E2E test results
  e2e-report:
    needs: [e2e-desktop]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write
    steps:
      - name: Download all E2E test results
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-desktop-results-*
          path: test-results
          merge-multiple: true

      - name: Publish E2E Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            test-results/**/*.xml
          check_name: 'E2E Desktop Test Results'
          comment_title: 'E2E Desktop Test Results'
          comment_mode: always
